pacman::p_load(devtools,caret,cluster,dplyr,fastDummies,leaps,pacman,tidyverse,skimr,fastDummies,GGally,DataExplorer,ggrepel,ggthemes,dslabs,scatterplot3d,rpart,rpart.plot,randomForest,xgboost,ROCR)
if (!require(mlba)) {
library(devtools)
install_github("gedeck/mlba/mlba", force=FALSE)
}
pacman::p_load(mlba,tidyverse)
df=readRDS("dec_train_df.rds")
holdout=readRDS("dec_holdout_df.rds")
levels(df$loan_default)
df$loan_default<-relevel(df$loan_default, ref= "Yes")
levels(df$loan_default)
# Downsample majority to match minority
set.seed(123)
df$loan_default <- as.factor(df$loan_default)
df.us=downSample(x=df %>% dplyr::select(-loan_default),
y=df$loan_default,
yname="loan_default"
)
table(df$loan_default)
table(df.us$loan_default)
ctrl <- trainControl(method = "cv", number = 10,
summaryFunction = twoClassSummary,
classProbs = TRUE,
savePredictions = 'final')
tuneGrid <- expand.grid(
alpha = seq(0.1, 1, by = 0.2),         # Elastic Net mixing
lambda = seq(0.001, 0.1, length = 10)    # Regularization strength
)
colSums(is.na(df.us))
logit_fit <- train(
loan_default~ .,
data = df.us,
method = "glmnet",
trControl = ctrl,
tuneGrid =tuneGrid,
metric = "ROC",
family = "binomial"
)
plot(logit_fit)
logit_fit$bestTune
logit_fit$results
coef(logit_fit$finalModel,logit_fit$bestTune$lambda)
pred.test <- holdout %>% dplyr::select(loan_default)
pred.test$netprob <- predict(logit_fit,
newdata = holdout,
type = "prob")[,"Yes"]
pred.test$netclass<- predict(logit_fit,
newdata = holdout,
type="raw")
table(pred.test$loan_default)
table(pred.test$netclass)
confusionMatrix(pred.test$netclass, pred.test$loan_default,positive="Yes")
pred <- prediction(pred.test$netprob, pred.test$loan_default)
perf <- performance(pred, "tpr", "fpr")
# Plot Curve
plot(perf, col = "blue", lwd = 2, main = "ROC Curve for Model 1")
abline(a = 0, b = 1, col = "red", lty = 2, lwd = 2)
auc <- performance(pred, "auc")@y.values[[1]]
print(paste("The AUC is ",round(auc,2)))
pred <- ROCR::prediction(pred.test$netprob,holdout$loan_default)
prec <- ROCR::performance(pred, "prec")
rec <- ROCR::performance(pred, "rec")
precision <- prec@y.values[[1]]
recall <- rec@y.values[[1]]
f1=2*precision*recall/(precision+recall)
f1[is.nan(f1)]=0
cutoffs=prec@x.values[[1]]
df_f1=data.frame(f1,cutoffs)
opt_idx <- which.max(f1)
opt_f1 <- df_f1[opt_idx,]
opt_f1
pred <- ROCR::prediction(pred.test$netprob,holdout$loan_default)
perf=performance(pred,"tpr","fpr")
tpr=perf@y.values[[1]]
fpr=perf@x.values[[1]]
thr=perf@alpha.values[[1]]
j=tpr-fpr
best_j=thr[which.max(j)]
print(best_j)
pred.test$netclass_51 <- factor(ifelse(pred.test$netprob > 0.5187898,
"Yes","No"),
levels=c("Yes","No"))
table(pred.test$loan_default)
table(pred.test$netclass_51)
confusionMatrix(pred.test$netclass_51, pred.test$loan_default,positive="Yes")
pred.test$netclass_46 <- factor(ifelse(pred.test$netprob > 0.4683588,
"Yes","No"),
levels=c("Yes","No"))
table(pred.test$loan_default)
table(pred.test$netclass_46)
confusionMatrix(pred.test$netclass_46, pred.test$loan_default,positive="Yes")
saveRDS(logit_fit,"dec_logit_model.rds")
saveRDS(pred.test,"dec_pred_test.rds")
coef(logit_fit$finalModel,logit_fit$bestTune$lambda)
pred.test$netclass_51 <- factor(ifelse(pred.test$netprob > 0.521216,
"Yes","No"),
levels=c("Yes","No"))
table(pred.test$loan_default)
table(pred.test$netclass_51)
confusionMatrix(pred.test$netclass_51, pred.test$loan_default,positive="Yes")
pred.test$netclass_46 <- factor(ifelse(pred.test$netprob > 0.4826321,
"Yes","No"),
levels=c("Yes","No"))
table(pred.test$loan_default)
table(pred.test$netclass_46)
confusionMatrix(pred.test$netclass_46, pred.test$loan_default,positive="Yes")
knitr::opts_chunk$set(echo = TRUE, message=FALSE,warning=FALSE)
knitr::opts_chunk$set(fig.width=8, fig.height=6)
if(require(pacman)==0)
{install.packages("pacman")}
pacman::p_load(devtools,caret,cluster,dplyr,fastDummies,leaps,pacman,tidyverse,skimr,fastDummies,GGally,DataExplorer,ggrepel,ggthemes)
if (!require(mlba)) {
library(devtools)
install_github("gedeck/mlba/mlba", force=FALSE)
}
pacman::p_load(mlba,tidyverse)
df = read.csv("score.csv", stringsAsFactors = TRUE)
train_df = read.csv("train.csv", stringsAsFactors = TRUE)
train_median <- median(train_df$revol_util, na.rm = TRUE)
str(df)
#Split data into categorical and numeric datasets
bank_numeric <- select_if(df, is.numeric)
bank_factor <- select_if(df, is.factor)
#Ensure dataframes correctly split
head(bank_numeric)
head(bank_factor)
#Summary Statistics for numeric Variables
summary(bank_numeric)
plot_missing(df)
# Look at structure and ensure these are all factor variables
str(bank_factor)
# Histograms for numeric variables
DataExplorer::plot_histogram(bank_numeric,
ggtheme=theme_minimal(),
ncol=3,
nrow=3)
# Boxplots based off the loan defaulting or not
#bank_numeric$loan_default <- df$loan_default
#DataExplorer::plot_boxplot(bank_numeric, by="loan_default",
#ggtheme = theme_minimal(),
#ncol=3,
#nrow=3)
# Create a heat map to check correlation between variables
DataExplorer::plot_correlation(bank_numeric,
type="continuous",
cor_args = list("use" = "pairwise.complete.obs")
)
# Remove these variables
df<-df%>%
select(-installment, -acc_now_delinq, -mths_since_last_delinq, -delinq_2yrs)
dim(df)
DataExplorer::plot_bar(bank_factor,
ggtheme = theme_minimal(),
ncol=4,
nrow=5)
# Remove variables that are not seen as needed
df<-df%>%
select(-emp_title, -issue_d, -title, -application_type, -hardship_flag, -earliest_cr_line, -last_credit_pull_d, -address, -sub_grade)
dim(df)
#Checking missing Values
colSums(is.na(df))
# Median imputation on the mort_acc variable
df$mort_acc[is.na(df$mort_acc)] <- 1
sum(is.na(df$mort_acc))
#Median imputation to the pub_rec_bankrupcies variable
df$pub_rec_bankruptcies[is.na(df$pub_rec_bankruptcies)] <- 0
sum(is.na(df$pub_rec_bankruptcies))
# Removing rows where revol_util is NA
#df <- df[!is.na(df$revol_util), ]
df$revol_util[is.na(df$revol_util)] <- train_median
#nrow(df)
# Capping the revol_util variable
Q1 <- quantile(df$revol_util, 0.25, na.rm = TRUE)
Q3 <- quantile(df$revol_util, 0.75, na.rm = TRUE)
IQR <- Q3 - Q1
upper_bound <- Q3 + 1.5 * IQR
df$revol_util[df$revol_util > upper_bound] <- upper_bound
summary(df$revol_util)
boxplot(df$revol_util, main = "Revolving Utilization", horizontal = TRUE)
# Capping the dti outlier
Q1 <- quantile(df$dti, 0.25, na.rm = TRUE)
Q3 <- quantile(df$dti, 0.75, na.rm = TRUE)
IQR <- Q3 - Q1
upper_bound <- Q3 + 1.5 * IQR
df$dti[df$dti > upper_bound] <- upper_bound
boxplot(df$dti, main = "DTI", horizontal = TRUE)
#Removing the "other" and "none" values
#df <- df[!df$home_ownership %in% c("OTHER", "NONE"), ]
df$home_ownership[df$home_ownership %in% c("OTHER","NONE")] <- "RENT"
df$home_ownership <- droplevels(df$home_ownership)
table(df$home_ownership)
#Reduce dimensions in the purpose variable
df$purpose <- fct_other(df$purpose, keep = c("debt_consolidation", "credit_card", "home_improvement"), other_level = "other")
table(df$purpose)
# Reducing dimensions on emp_length
df <- df %>%
mutate(emp_length = case_when(
emp_length %in% c("< 1 year", "1 year", "2 years", "3 years") ~ "0-3 years",
emp_length %in% c("4 years", "5 years", "6 years") ~ "4-6 years",
emp_length %in% c("7 years", "8 years", "9 years") ~ "7-9 years",
emp_length == "10+ years" ~ "10+ years",
TRUE ~ "Unknown"
))
df$emp_length <- factor(df$emp_length,
levels = c("0-3 years", "4-6 years", "7-9 years", "10+ years","Unknown"),
ordered = TRUE)
#df <- df %>%
#  filter(!is.na(emp_length) & emp_length != "Unknown")
# Dummy encoding all remaining categorical variables
df <- fastDummies::dummy_cols(df,
select_columns = c(
"term",
"home_ownership",
"verification_status",
"grade",
"purpose",
"initial_list_status",
"debt_settlement_flag",
"emp_length"),
remove_first_dummy = TRUE,      # avoids dummy variable trap
remove_selected_columns = TRUE) # removes original factor columns
# dti * int_rate interaction term
df$interaction_dti_interest <- df$dti * df$int_rate
# Show correlation
hist(df$interaction_dti_interest,
main = "Interaction",
xlab = "DTI * int_rate",
col = "lightblue",
border = "white")
summary(df)
names(df) <- gsub(" ", "_", names(df))
names(df) <- gsub("-", "_", names(df))
names(df) <- gsub("\\+", "plus", names(df))
saveRDS(df, "score_df.rds")
Xgb_Model = readRDS("dec_logit_model.rds")
# Predict using the trained model
y_pred <- predict(Xgb_Model, newdata=df)
length(y_pred)
# Combine predictions with IDs
predictions <- data.frame(ID = df$ID, loan_status = y_pred)
# Write to CSV
write.csv(predictions, "group5AA_Black-Boopathy_submission_file.csv", row.names = FALSE)
Xgb_Model = readRDS("dec_logit_model.rds")
# Predict using the trained model
y_pred <- predict(Xgb_Model, newdata=df)
y_pred <- ifelse(y_pred == "Yes", 1, 0)
# Combine predictions with IDs
predictions <- data.frame(ID = df$ID, loan_status = y_pred)
# Write to CSV
write.csv(predictions, "group5AA_Black-Boopathy_submission_file.csv", row.names = FALSE)
pred.prob <- predict(logit_fit,
newdata = df,
type = "prob")[,"Yes"]
logit_fit = readRDS("dec_logit_model.rds")
pred.prob <- predict(logit_fit,
newdata = df,
type = "prob")[,"Yes"]
logit_fit = readRDS("dec_logit_model.rds")
# Predict using the trained model
#y_pred <- predict(Xgb_Model, newdata=df)
#y_pred <- ifelse(y_pred == "Yes", 1, 0)
pred.prob <- predict(logit_fit,
newdata = df,
type = "prob")[,"Yes"]
y_pred <- factor(ifelse(pred.prob > 0.4826321,
"1","0"),
levels=c("1","0"))
# Combine predictions with IDs
predictions <- data.frame(ID = df$ID, loan_status = y_pred)
# Write to CSV
write.csv(predictions, "group5AA_Black-Boopathy_submission_file.csv", row.names = FALSE)
logit_fit = readRDS("dec_logit_model.rds")
# Predict using the trained model
#y_pred <- predict(Xgb_Model, newdata=df)
#y_pred <- ifelse(y_pred == "Yes", 1, 0)
pred.prob <- predict(logit_fit,
newdata = df,
type = "prob")[,"Yes"]
y_pred <- factor(ifelse(pred.prob > 0.521216,
"1","0"),
levels=c("1","0"))
# Combine predictions with IDs
predictions <- data.frame(ID = df$ID, loan_status = y_pred)
# Write to CSV
write.csv(predictions, "group5AA_Black-Boopathy_submission_file.csv", row.names = FALSE)
knitr::opts_chunk$set(echo = TRUE, message=FALSE,warning=FALSE)
knitr::opts_chunk$set(fig.width=6, fig.height=4)
if(require(pacman)==0)
{install.packages("pacman")}
pacman::p_load(devtools,caret,fastDummies,tidyverse,skimr, GGally,DataExplorer,ggrepel,ggthemes,MASS,dslabs,rpart,rpart.plot,
randomForest,xgboost,ROCR,recipes,nnet,DiagrammeR,
webshot2,doParallel,dplyr)#,keras3,tensorflow)
#library(keras3)
#library(tensorflow)
df_train <- readRDS("dec_train_df.rds")
df_holdout<-readRDS("dec_holdout_df.rds")
df_train$loan_default<-relevel(df_train$loan_default, ref= "Yes")
levels(df_train$loan_default)
df_holdout$loan_default<-relevel(df_holdout$loan_default, ref="Yes")
levels(df_holdout$loan_default)
rec <- recipe(loan_default ~ ., data = df_train) %>%
step_range(all_numeric_predictors(), min = 0, max = 1)
prep_loan <- prep(rec)
loan_prepped_train <- bake(prep_loan, new_data = df_train)
loan_prepped_holdout <- bake(prep_loan, new_data = df_holdout)
set.seed(123)
loan_prepped_train$loan_default <- as.factor(loan_prepped_train$loan_default)
loan_prepped_train.us=downSample(x=loan_prepped_train %>% dplyr::select(-loan_default),
y=loan_prepped_train$loan_default,
yname="loan_default"
)
table(loan_prepped_train.us$loan_default)
table(loan_prepped_train$loan_default)
tune_grid <- expand.grid(
size=c(1,2,3,4,5),
decay=seq(0,0.01,by=0.001)
)
ctrl <- trainControl(
method="cv",
number=10,
classProbs=TRUE,
summaryFunction=twoClassSummary
)
set.seed(123)
# Set up Cluster
cores=detectCores()
cl=makeCluster(cores-1)
registerDoParallel(cl)
nn_model_1 <- train(
loan_default~.,
data=loan_prepped_train.us,
method="nnet",
trControl=ctrl,
tuneGrid=tune_grid,
metric="ROC",
maxit=500,
trace=FALSE
)
# Stop Cluster
stopCluster(cl)
registerDoSEQ()
saveRDS(nn_model_1,"dec_nn_us_model.rds")
#nnet_model = readRDS("nn_us_model.rds")
predmodels <- loan_prepped_holdout %>% dplyr::select(loan_default)
predmodels$nnet_pred.prob <- predict(nnet_model,newdata = loan_prepped_holdout,type="prob")[,"Yes"]
nnet_model = readRDS("dec_nn_us_model.rds")
predmodels <- loan_prepped_holdout %>% dplyr::select(loan_default)
predmodels$nnet_pred.prob <- predict(nnet_model,newdata = loan_prepped_holdout,type="prob")[,"Yes"]
predmodels$nnet_pred.class <- predict(nnet_model, newdata = loan_prepped_holdout, type = "raw")
confusionMatrix(predmodels$nnet_pred.class,predmodels$loan_default,positive="Yes")
probabilities=predict(nnet_model,newdata=loan_prepped_holdout,type="prob")
probabilities$actual=loan_prepped_holdout$loan_default
# Create Prediction Object
pred = prediction(probabilities[,"Yes"], loan_prepped_holdout$loan_default)
# Create Performance Object
perf = performance(pred, "tpr", "fpr")
auc = performance(pred,"auc")
auc_value=auc@y.values[[1]]
# Plot the ROC curve
plot(perf, col = "blue", lwd = 2, main = "ROC Curve")
abline(a=0, b=1, col="red", lty=2)
legend("bottomright",legend=paste("AUC = ",round(auc_value,3)),col="blue",lwd=2)
knitr::opts_chunk$set(echo = TRUE, message=FALSE,warning=FALSE)
knitr::opts_chunk$set(fig.width=8, fig.height=6)
if(require(pacman)==0)
{install.packages("pacman")}
pacman::p_load(devtools,caret,cluster,dplyr,fastDummies,leaps,pacman,tidyverse,skimr,fastDummies,GGally,DataExplorer,ggrepel,ggthemes)
if (!require(mlba)) {
library(devtools)
install_github("gedeck/mlba/mlba", force=FALSE)
}
pacman::p_load(mlba,tidyverse)
df = read.csv("score.csv", stringsAsFactors = TRUE)
train_df = read.csv("train.csv", stringsAsFactors = TRUE)
train_median <- median(train_df$revol_util, na.rm = TRUE)
str(df)
#Split data into categorical and numeric datasets
bank_numeric <- select_if(df, is.numeric)
bank_factor <- select_if(df, is.factor)
#Ensure dataframes correctly split
head(bank_numeric)
head(bank_factor)
#Summary Statistics for numeric Variables
summary(bank_numeric)
plot_missing(df)
# Look at structure and ensure these are all factor variables
str(bank_factor)
# Histograms for numeric variables
DataExplorer::plot_histogram(bank_numeric,
ggtheme=theme_minimal(),
ncol=3,
nrow=3)
# Boxplots based off the loan defaulting or not
#bank_numeric$loan_default <- df$loan_default
#DataExplorer::plot_boxplot(bank_numeric, by="loan_default",
#ggtheme = theme_minimal(),
#ncol=3,
#nrow=3)
# Create a heat map to check correlation between variables
DataExplorer::plot_correlation(bank_numeric,
type="continuous",
cor_args = list("use" = "pairwise.complete.obs")
)
# Remove these variables
df<-df%>%
select(-installment, -acc_now_delinq, -mths_since_last_delinq, -delinq_2yrs)
knitr::opts_chunk$set(echo = TRUE, message=FALSE,warning=FALSE)
knitr::opts_chunk$set(fig.width=8, fig.height=6)
if(require(pacman)==0)
{install.packages("pacman")}
pacman::p_load(devtools,caret,cluster,dplyr,fastDummies,leaps,pacman,tidyverse,skimr,fastDummies,GGally,DataExplorer,ggrepel,ggthemes)
if (!require(mlba)) {
library(devtools)
install_github("gedeck/mlba/mlba", force=FALSE)
}
pacman::p_load(mlba,tidyverse)
df = read.csv("score.csv", stringsAsFactors = TRUE)
train_df = read.csv("train.csv", stringsAsFactors = TRUE)
train_median <- median(train_df$revol_util, na.rm = TRUE)
str(df)
#Split data into categorical and numeric datasets
bank_numeric <- select_if(df, is.numeric)
bank_factor <- select_if(df, is.factor)
#Ensure dataframes correctly split
head(bank_numeric)
head(bank_factor)
#Summary Statistics for numeric Variables
summary(bank_numeric)
plot_missing(df)
# Look at structure and ensure these are all factor variables
str(bank_factor)
# Histograms for numeric variables
DataExplorer::plot_histogram(bank_numeric,
ggtheme=theme_minimal(),
ncol=3,
nrow=3)
# Boxplots based off the loan defaulting or not
#bank_numeric$loan_default <- df$loan_default
#DataExplorer::plot_boxplot(bank_numeric, by="loan_default",
#ggtheme = theme_minimal(),
#ncol=3,
#nrow=3)
# Create a heat map to check correlation between variables
DataExplorer::plot_correlation(bank_numeric,
type="continuous",
cor_args = list("use" = "pairwise.complete.obs")
)
# Remove these variables
df<-df%>%
select(-installment, -acc_now_delinq, -mths_since_last_delinq, -delinq_2yrs)
View(df)
df<-df%>%
select(-installment, -acc_now_delinq, -mths_since_last_delinq, -delinq_2yrs)
View(df)
df<-df%>%
select(-installment, -acc_now_delinq, -mths_since_last_delinq, -delinq_2yrs)
# Remove these variables
df<-df%>%
select(-installment, -acc_now_delinq, -mths_since_last_delinq, -delinq_2yrs)
knitr::opts_chunk$set(echo = TRUE, message=FALSE,warning=FALSE)
knitr::opts_chunk$set(fig.width=8, fig.height=6)
if(require(pacman)==0)
{install.packages("pacman")}
pacman::p_load(devtools,caret,cluster,dplyr,fastDummies,leaps,pacman,tidyverse,skimr,fastDummies,GGally,DataExplorer,ggrepel,ggthemes)
if (!require(mlba)) {
library(devtools)
install_github("gedeck/mlba/mlba", force=FALSE)
}
pacman::p_load(mlba,tidyverse)
df = read.csv("holdout.csv", stringsAsFactors = TRUE)
knitr::opts_chunk$set(echo = TRUE, message=FALSE,warning=FALSE)
knitr::opts_chunk$set(fig.width=8, fig.height=6)
if(require(pacman)==0)
{install.packages("pacman")}
pacman::p_load(devtools,caret,cluster,dplyr,fastDummies,leaps,pacman,tidyverse,skimr,fastDummies,GGally,DataExplorer,ggrepel,ggthemes)
if (!require(mlba)) {
library(devtools)
install_github("gedeck/mlba/mlba", force=FALSE)
}
pacman::p_load(mlba,tidyverse)
df = read.csv("holdout.csv", stringsAsFactors = TRUE)
str(df)
#Split data into categorical and numeric datasets
bank_numeric <- select_if(df, is.numeric)
bank_factor <- select_if(df, is.factor)
#Ensure dataframes correctly split
head(bank_numeric)
head(bank_factor)
#Summary Statistics for numeric Variables
summary(bank_numeric)
plot_missing(df)
# Look at structure and ensure these are all factor variables
str(bank_factor)
# Histograms for numeric variables
DataExplorer::plot_histogram(bank_numeric,
ggtheme=theme_minimal(),
ncol=3,
nrow=3)
# Boxplots based off the loan defaulting or not
#bank_numeric$loan_default <- df$loan_default
#DataExplorer::plot_boxplot(bank_numeric, by="loan_default",
#ggtheme = theme_minimal(),
#ncol=3,
#nrow=3)
# Create a heat map to check correlation between variables
DataExplorer::plot_correlation(bank_numeric,
type="continuous",
cor_args = list("use" = "pairwise.complete.obs")
)
# Remove these variables
df<-df%>%
select(-installment, -acc_now_delinq, -mths_since_last_delinq, -delinq_2yrs)
